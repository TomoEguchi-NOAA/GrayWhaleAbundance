---
title: "ABUNDANCE OF EASTERN NORTH PACIFIC GRAY WHALES 2023/2024"
author: "Tomo Eguchi, Aimee Lang, David Weller"
date: "`r Sys.Date()`"
output: 
  bookdown::word_document2: default
  header-includes:
  - \usepackage{ragged2e}
  - \renewcommand{\footnotesize}{\10 \justify}
bibliography: reference.bib
csl: marine-ecology-progress-series.csl  
---

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
save.fig <- F

source("Granite_Canyon_Counts_fcns.R")
library(tidyverse)
library(lubridate)
library(flextable)
library(readr)
library(segmented)
library(knitr)

# Define the analysis year.
YEAR <- 2024

# knit_hooks$set(inline = function(x) {
#   prettyNum(x, big.mark = ",")
# })

format.big.number <- function(x) {
  format(x, scientific=F, digits = 6, big.mark = ",")
}

set_flextable_defaults(font.size = 9,
                       font.family = "Cambria")

# Estimates from Laake et al. are here:
col.defs <- cols(Year = col_character(),
                 Nhat = col_double(),
                 CV = col_double())

# Function from Laake's code
conf.int = function(abundance, CV, alpha=0.05, digits=2, prt=FALSE){
  # Computes confidence intervals based on lognormal distr.
  # JMB / NMML / 11 Sep 2008
  
  if (alpha <0 || alpha > .999) stop("alpha must be in (0,1)")
  z = round(abs(qnorm(alpha/2)),2)
  if (prt) cat("N:",abundance,"  cv:",CV,"  alpha:",alpha,"  z:",z,"\n")
  C <- exp(z * sqrt(log(1 + CV^2)))
  SL <- round(abundance/C,digits)
  SU <- round(abundance * C,digits)
  data.frame(SL,SU)
}

Laake.estimates <- read_csv(file = "Data/Laake et al 2012 Table 9 Nhats.csv",
                            col_types = col.defs)

Laake.CI <- conf.int(abundance = Laake.estimates$Nhat, CV = Laake.estimates$CV)

Laake.estimates %>% 
  mutate(SE = CV * Nhat,
         LCL = Laake.CI$SL,
         UCL = Laake.CI$SU,
         Season = lapply(strsplit(Year, "_"), 
                         FUN = function(x) paste0(x[1], "/", x[2])) %>% 
           unlist) %>%
  dplyr::select(Season, Nhat, SE, LCL, UCL)  %>%
  mutate(Year = lapply(str_split(Season, "/"), 
                       FUN = function(x) x[2]) %>% 
           unlist() %>% 
           as.numeric()) -> Laake.estimates

# Bring in data from Rugh et al. 2001 (median dates)
Rugh.data <- read_csv(file = "Data/Rugh et al 2001 Table 1 Median Date.txt",
                      col_types = cols(Season = col_character(),
                                       Median_Date = col_date(format = "%Y-%m-%d"))) %>%
  mutate(Year = lapply(str_split(Season, "/"), 
                       FUN = function(x) x[2]) %>% 
           unlist() %>% 
           as.numeric(),
         median.idx = (Median_Date - as.Date(paste0((Year-1), "-12-01"))) %>%
           as.numeric())

# Durban estimates:
seasons <- c("2006/2007", "2007/2008", "2009/2010", "2010/2011", 
             "2014/2015", "2015/2016", "2019/2020", "2021/2022",
             "2022/2023", "2023/2024")

# The most recent estimates (2023/2024) are here:
N.hats.2024 <- read_csv(file = "Data/abundance_2024_85min.csv",
                        col_types = cols(Season = col_character(),
                                         total.mean = col_double(),
                                         total.CV = col_double(),
                                         total.median = col_double(),
                                         total.LCL = col_double(),
                                         total.UCL = col_double())) %>%
  mutate(Year = lapply(str_split(Season, "/"), 
                       FUN = function(x) x[2]) %>% 
           unlist() %>% 
           as.numeric(),
         Method = "Durban")

# From Durban et al. 2015, Fig 1 (J. Cetacean Res. Manage. 15:61-68)
Durban.2015 <- data.frame(Year = c(2007, 2008, 2010, 2011),
                          Season = seasons[1:4],
                          Nhat = c(20750, 17820, 21210, 20990),
                          LCL = c(18860, 16150, 19420, 19230),
                          UCL = c(23320, 19920, 23250, 22900),
                          Method = "Durban")

# From Eguchi et al. 2023, Table 1 (NOAA Tech Memo NMFS-SWFSC-680)
Eguchi.2023 <- data.frame(Year = c(2015, 2016, 2020, 2022, 2023),
                          Season = seasons[5:9],
                          Nhat = c(28790, 26960, 20580, 16650, 14526),
                          LCL = c(23620, 24420, 18700, 15170, 13194.8),
                          UCL = c(39210, 29830, 22870, 18335, 16040),
                          Method = "Durban")
                               
# UMEs
UMEs <- data.frame(Season = c("1999/2000", "2000/2001", 
                              "2019/2020", "2020/2021", 
                              "2021/2022", "2022/2023"),
                   Year = c(1999, 2000, 2019, 2020, 2021, 2022))

# This is for the 2024 analysis. 
end.year <- 2024
all.years <- data.frame(Year = seq(from = min(Laake.estimates$Year), 
                                  to = end.year))

# Observer list gets updated as new observers are added. 
# obs.list <- read.csv("Data/ObserverList2023.csv", header = T) 
# colnames(obs.list) <- c("obs", "ID")

x <- length(seasons)

# Change the pattern as needed - this should be standardized.
all.files. <- list.files(path = paste0("Data/", end.year, "/"),
                         pattern = "Edited_GW")

data.first. <- get.data(dir = "Data/", 
                        YEAR = end.year, 
                        FILES = all.files., 
                        ff = 1)

data.last. <- get.data(dir ="Data/", 
                       YEAR = end.year, 
                       FILES = all.files.,
                       ff = length(all.files.))

data.all.list <- list()
for (k in 1:length(all.files.)){
  data.all.list[[k]] <- get.data(dir = "Data/", 
                                 YEAR = end.year, 
                                 FILES = all.files.,
                                 ff = k) 
}

data.all <- do.call(rbind, data.all.list)

# observers                  
unique.obs <- data.all %>% 
  filter(V2 == "P") %>%
  dplyr::select(V5) %>% 
  unique()

# survey hours
data.all %>% 
  filter(V2 == "B") %>%
  dplyr::select(V2, begin) -> tmp.B

data.all %>% 
  filter(V2 == "E") %>%
  dplyr::select(V2, begin) -> tmp.E

survey.hrs <- 24 * (tmp.E$begin - tmp.B$begin)

data.all %>% 
  dplyr::select(V3) %>%
  mutate(Date = as.Date(V3, format = "%m/%d/%Y")) -> survey.dates 

# sightings
data.all %>% filter(V2 == "S") %>%
  mutate(Date = as.Date(V3, format = "%m/%d/%Y"),
         GroupID = as.numeric(V5), 
         n = as.numeric(V9)) %>%
  dplyr::select(Date, GroupID, n) %>% #-> tmp
  group_by(Date, GroupID) %>% #group by the whale group number
  #summarize(N = max(as.numeric(V9), na.rm = T)) %>% 
  summarize(N = last(n)) -> whale.groups

# daily counts
whale.groups %>%
  group_by(Date) %>%
  summarize(N = sum(N)) -> whale.groups.daily

```

## Introduction {.unnumbered}

The Southwest Fisheries Science Center (SWFSC) regularly conducts shore-based surveys of eastern North Pacific (ENP) gray whales (*Eschrichtius robustus*) to estimate abundance. These estimates are obtained from visual survey data collected off central California between December and February during the gray whale southward migration, and provide regular updates to a time series of abundance estimates that began in 1967 (@laake2012). Surveys have recorded a generally increasing trend in ENP gray whale abundance until the 2015/2016 season. Since then, however, estimated abundances indicated a decline from 2015/2016 of 26,960 whales (95% CI = 24,420-29,830) to 14,526 whales (95% CI = 13,194 - 16,040) in 2022/2023 (Eguchi et al. 2023a). Even though these estimates were greater than the estimate from 1967 (13,426 whales, CV = 0.094, Laake et al. 2012), the observed decline in the consecutive surveys raised a concern about the status of the population. This report presents a new estimate of abundance for ENP gray whales migrating southward off the central California coast between December 2023 and February 2024.

## Methods {.unnumbered}

Data for this updated abundance estimate were collected during the `r YEAR-1`-`r YEAR` southward ENP gray whale migration between `r min(as.Date(data.first.$V3, format = "%m/%d/%Y")) %>% format("%d %B %Y")` and `r max(as.Date(data.last.$V3, format = "%m/%d/%Y")) %>% format("%d %B %Y")`. Counts were made from a shore-based watch station at Granite Canyon, California, by teams of observer pairs rotating from a larger pool. Each survey day was split into six 90 minute shifts. As was the case for the previous analyses since 2006, only shifts with at least 85 minutes of survey effort were included in the analysis. Some shifts were less than 85 minutes due to inclement weather and less-than-ideal sighting conditions (e.g., Beaufort sea state greater than 4). Sampling and analytical methods are described in a previous publication @durban2015a.

The estimate of abundance reported here was computed using the N-mixture modeling approach used previously by SWFSC for surveys conducted between 2006 and `r YEAR-1` (Durban et al. 2015, 2017, Stewart and Weller 2021a, Eguchi et al. 2022a, Eguchi et al. 2023a). In this approach, the sighting probability of shore-based observers is estimated by using data from replicate surveys (i.e., data collected simultaneously by two independent observer teams) that were completed in 2009/2010 and 2010/2011 and covariates that affect sighting probabilities (i.e., visibility, sea state, and observers). These sighting probability estimates allowed the total number of whales passing through the survey area during a watch period to be estimated from the observed number of whales, even in years when replicate surveys were not conducted.

In the analysis, the start date of the southward migration for the Granite Canyon study site is fixed at 1 December and the end date at 28 February, where the number of whales passing the watch station on those two dates is assumed zero. The daily count data are assumed to be random deviates from binomial distributions with the estimated sighting probability and the true but unknown number of whales in the sampling area, which is assumed to change as a function of the number of days since 1 December. The model fits two possible functions to the daily counts of whales and select a function that fits better for each count. These functions are (a) a normal distribution with the peak in the daily number of whales passing occurs at the midpoint of the migration and (b) a spline fit that allows the overall migration curve to flexibly match the observed daily counts without expectations about the shape of the curve. The model then internally selects which of these two candidate migration curves best matches the daily number of observed whales. The final abundance estimate is the sum of the total number of whales passing the survey area each day (i.e., both observed whales and the estimated number of unobserved whales), with a correction factor applied to account for those that migrate through the study area at night (Perryman et al. 1999). The modeling approach is described in detail in Durban et al. (2015; 2017).

Because the N-mixture modeling approach uses all data since 2006/2007 to estimate parameters that are shared among yearly datasets, annual abundance estimates change as more data are added to the analysis. In the past, we only provided the new estimate and kept the estimates for previous years as they were provided in the reports. This year, however, we provide updated estimates as well as estimates in the previous reports. In the future reports, we plan to provide only updated estimates for all years.

Similarly to the last two reports (Eguchi et al. 2022a, 2023a), we examined the annual median migration date, which was defined previously [@rugh_timing_2001] as "the date when 50% of the whale sightings had been recorded at a research site or (if data were not available for calculating the median) the date corresponding with the apex of a unimodal sighting curve." Using the first definition, these dates are determined using sightings rather than estimated abundances. The latter definition, however, is applicable for estimated numbers, if the model has a unimodal distribution. In our approach, the model selected a better function between the normal and spline fits for each day. Consequently, the results are not unimodal for some years (Figure \@ref(fig:Figure-daily-fit)). We, therefore, use the date when 50% of the whale sightings had been recorded as the median date.

Linear models were fitted to the relationship between median dates and year. In order to estimate change points, if existed, we fitted segmented linear models using the *segmented* package (v. `r packageVersion("segmented")`, @muggeo_interval_2017). All statistical analyses were conducted within the R statistical environment (v. `r paste0(R.Version()$major, ".", R.Version()$minor)`, R Core Team 2023).

## Results and Discussion {.unnumbered}

```{r results, echo=FALSE, warning=FALSE, message= FALSE}
#estimates.2023 <- read_csv(file = "Data/abundance_2023_85min.csv")

Laake.estimates %>%
  dplyr::select(Year, Season, Nhat, LCL, UCL) %>%
  mutate(Method = "Laake") %>%
  rbind(Durban.2015) %>%
  rbind(Eguchi.2023) -> all.estimates.2023

Laake.estimates %>%
  dplyr::select(Year, Season, Nhat, LCL, UCL) %>%
  mutate(Method = "Laake") %>%
  rbind(N.hats.2024 %>% 
          dplyr::select(Year, Season, total.median, total.LCL, total.UCL) %>%
          transmute(Year = Year,
                    Season = Season,
                    Nhat = total.median,
                    LCL = total.LCL,
                    UCL = total.UCL,
                    Method = "Durban")) -> all.estimates.2024

all.estimates.2024$Nhat.2023 <- c(all.estimates.2023$Nhat, NA)


#write.csv(all.estimates, file = "Data/all_estimates_2023.csv")
# Create all years without skipping unobserved years:
all.years %>% mutate(Year0 = Year - 1,
                     Season = paste(Year0, Year, sep = "/")) %>%
  left_join(all.estimates.2023) -> all.years.2023.df

all.years %>% mutate(Year0 = Year - 1,
                     Season = paste(Year0, Year, sep = "/")) %>%
  left_join(all.estimates.2024) -> all.years.2024.df

p.Nhat.2024 <- ggplot(data = all.years.2024.df) + 
  geom_point(aes(x = Season, y = Nhat, color = Method)) + 
  geom_errorbar(aes(x = Season, ymin = LCL, ymax = UCL, color = Method),
                size = 1) +
  geom_tile(data = UMEs,
            aes(x = Season, y = 22500, width = 1, height = 35000),
            fill = "gold", alpha = 0.3) +
  scale_color_discrete(breaks = c("Durban", "Laake")) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 9),
        legend.position = "top") +
  xlab("Season") +
  ylab("Abundance")

if (save.fig)
  ggsave(filename = paste0("figures/nhats_", YEAR, ".png"), 
         plot = p.Nhat.2024,
         device = "png", dpi = 600)


# Find daily data:
data.2024 <- readRDS(file = "RData/V2.1_Feb2024/out_2024_min85_Tomo_v2.rds")

data.2024$Complete_Data %>% 
  group_by(BeginDay) %>%
  summarize(Date = as.Date("2023-11-30") + BeginDay[1],
            n.day = sum(n),
            n.group = sum(npods)) -> daily.counts

data.2024$Data_Out %>% 
  group_by(BeginDay) %>%
  summarize(Date = as.Date("2023-11-30") + BeginDay[1],
            n.day = sum(n),
            n.group = sum(npods)) -> daily.counts_Data_Out

# Get the output from WinBUGS run. I use the version 2 output results
# because V1 had some errors for the past years.  
WinBUGS.results <- readRDS(paste0("RData/WinBUGS_", x, "yr_v2_min85.rds"))
Nhat.2024 <- WinBUGS.results$BUGS_out$mean$Corrected.Est[x] 
SD.Nhat.2024 <- WinBUGS.results$BUGS_out$sd$Corrected.Est[x] 
CV.Nhat.2024 <- SD.Nhat.2024/Nhat.2024

# All data:
# Extract estimated counts
Daily.Est <- WinBUGS.results$BUGS_out$sims.list$Daily.Est
sp <- WinBUGS.results$BUGS_out$sims.list$sp
com <- WinBUGS.results$BUGS_out$sims.list$com
Corrected.Est <- WinBUGS.results$BUGS_out$sims.list$Corrected.Est

n <- WinBUGS.results$BUGS.data$n

stats.list <- vector(mode = "list",
                     length = dim(Daily.Est)[3])

for (k in 1:dim(Daily.Est)[3]){
  # Daily.Est.list[[k]] <- Daily.Est[,,k]
  # Daily.Est.UCIs[[k]] <- apply(Daily.Est[,,k],2,quantile,0.975)
  # Daily.Est.LCIs[[k]] <- apply(Daily.Est[,,k],2,quantile,0.275)
  # 
  # sp.list[[k]] <- sp[,,k]
  # com.list[[k]] <- com[,,k]
  
  stats.list[[k]] <- data.frame(Daily.Est.median = apply(Daily.Est[,,k], 2,
                                                            median),
                                   Daily.Est.LCL = apply(Daily.Est[,,k], 2,
                                                         quantile,0.275),
                                   Daily.Est.UCL = apply(Daily.Est[,,k], 2,
                                                         quantile,0.975),
                                   sp.median = apply(exp(sp[,,k]), 2,
                                                     median),
                                   sp.LCL = apply(exp(sp[,,k]), 2,
                                                  quantile,0.025),
                                   sp.UCL = apply(exp(sp[,,k]), 2,
                                                  quantile,0.975),
                                   com.median = apply(exp(com[,,k]), 2,
                                                      median),
                                   com.LCL = apply(exp(com[,,k]), 2,
                                                   quantile,0.025),
                                   com.UCL = apply(exp(com[,,k]), 2,
                                                   quantile,0.975),
                                   #total.median = apply(exp(sp[,,k]), 1, sum),
                                   days = 1:dim(Daily.Est)[2],
                                   Season = seasons[k])
}


all.stats <- do.call("rbind", stats.list) %>% group_by(Season)

estimate.new <- all.estimates.2024 %>% filter(Year == YEAR)
estimate.last.year <- all.estimates.2024 %>% filter(Year == (YEAR-1))


# find daily effort: there are 90 days, where 1st and 90th are zeros.
daily.effort <- daily.n <- daily.N <- matrix(nrow = 88, ncol = x)
Watch.Length <- WinBUGS.results$BUGS.data$Watch.Length
day.mat <- WinBUGS.results$BUGS.data$day
ns <- rbind(n[,1,], matrix(NA, nrow = 2, ncol = x))

for (y in 1:x){
  for (j in 2:89){
    daily.effort[j-1, y] <- sum(Watch.Length[day.mat[1:nrow(day.mat) , y] == j, y], 
                                na.rm = T)
    daily.n[j-1, y] <- sum(ns[day.mat[1:nrow(day.mat) ,y] == j, y], na.rm = T)
    daily.N[j-1, y] <- daily.n[j-1,y]/daily.effort[j-1,y]
  }
}

daily.N.df <- data.frame(daily.N) 
colnames(daily.N.df) <- seasons
daily.N.df %>% pivot_longer(everything(),
                            names_to = "Season", 
                            values_to = "N") %>%  
  arrange(Season) -> daily.N.df.long

daily.N.df.long$days <- rep(2:89, times = x)

daily.n.df <- data.frame(daily.n) 
colnames(daily.n.df) <- seasons
daily.n.df %>% pivot_longer(everything(),
                            names_to = "Season", 
                            values_to = "n") %>%  
  arrange(Season) -> daily.n.df.long

daily.n.df.long$days <- rep(2:89, times = x)

p.daily <- 
  ggplot(data = all.stats) +
  geom_line(aes(x = days, y = Daily.Est.median)) +
  geom_ribbon(aes(x = days, 
                  ymin = Daily.Est.LCL, 
                  ymax = Daily.Est.UCL),
              fill = "orange", 
              alpha = 0.5) + 
  # geom_point(data = daily.n.df.long,
  #            aes(x = days, y = n)) +
  geom_point(data = daily.N.df.long,
             aes(x = days, y = N)) +
  facet_wrap(vars(Season))+
  xlab("Days since December 1") + 
  ylab("Whales per day")

if (save.fig)
  ggsave(filename = paste0("figures/daily_estimates_", YEAR, ".png"), 
         plot = p.daily,
         device = "png", dpi = 600)

```

### Abundance estimates {.unnumbered}

From `r format(as.Date("2023-11-30") + data.2024$Data_Out[1, "BeginDay"], "%d %B %Y")` to `r format(as.Date("2023-11-30") + data.2024$Data_Out[nrow(data.2024$Data_Out), "BeginDay"], "%d %B %Y")`, `r length(unique(data.2024$Data_Out$obs))` trained observers completed `r signif(sum(data.2024$Data_Out$dur) * 24, 4)` hours of survey effort over `r length(unique(data.2024$Data_Out$BeginDay))` survey days. A total of `r sum(data.2024$Data_Out$npods)` groups of `r sum(data.2024$Data_Out$n)` gray whales were counted, with the highest daily count of `r max(daily.counts$n.day)` whales on `r daily.counts %>% filter(n.day == max(n.day)) %>% dplyr::select("Date") %>% as.data.frame() %>% format("%d %B %Y")` (Figure \@ref(fig:Figure-daily-fit)). Due to the inclement weather and other constraints (e.g., poor visibility due to fog and rain), some observation periods were \< 85 min in duration and were excluded from analysis. Consequently, `r signif(sum(data.2024$Complete_Data$dur) * 24, 4)` hours of survey effort was retained for further analyses. Estimated total abundance of gray whales during the 2023/2024 southbound migration was `r estimate.new$Nhat %>% format.big.number()` (95% Credible Interval: `r estimate.new$LCL %>% format.big.number()` - `r estimate.new$UCL %>% format.big.number()`, CV = `r signif(CV.Nhat.2024, 3)`, 20-percentile = `r quantile(WinBUGS.results$BUGS_out$sims.list$Corrected.Est[,x], 0.2) %>% format.big.number()`). This estimate includes the multiplicative correction factor for nighttime passage (mean = 1.0875, SD = 0.03625, Perryman et al. 1999). This estimate represents a `r abs(signif((estimate.new$Nhat - estimate.last.year$Nhat)/estimate.last.year$Nhat, 3)) * 100`% increase from the previous estimate for the 2022/2023 season (`r estimate.last.year$Nhat %>% format.big.number()`; Table \@ref(tab:Table-Nhats-v1)). After an observed continuous decline from the 2014/2015 season, this was a welcome result. (Figure \@ref(fig:Figure-nhats-v1)). The observed increase, however, cannot be explained by biological reasons alone for gray whales. Sampling and modeling errors likely contributed to under and over estimations of annual abundance.

Using the long time series of estimated abundance of ENP gray whales from Granite Canyon, CA, a recent integrated population modeling analysis indicated that fluctuations in the gray whale abundance was likely associated with availability of benthic prey in the Arctic region ([@stewart_boom-bust_2023]). The time series suggests that observed fluctuations are common. The observed declines in abundance might represent short-term events that had not resulted in any detectable longer-term impacts on the population. That is, despite occasional declines in abundance since the time-series of data began in 1967, the population has recovered (Figure \@ref(fig:Figure-nhats-v1). Given the rapid changes in ocean environment, especially in the Arctic region where gray whales forage, continuous monitoring is essential to determine the degree of fluctuations in the future. NOAA/NMFS plan to closely monitor the population with regular surveys to estimate abundance, calf production and body condition of gray whales. The results of these research efforts will continue to provide the best scientific information available regarding the status of the population.

### Migration phenology {.unnumbered}

```{r timing1, echo=FALSE, message=FALSE, warning=FALSE}


total.n <- colSums(daily.n)
median.n <- floor(total.n/2)
cumsum.n <- apply(daily.n, MARGIN = 2, FUN = cumsum)
median.idx <- vector(mode = "numeric", length = x )
k <- 6
idx.vec <- seq(1, nrow(daily.n))
for (k in 1:x){
  tmp <- cumsum.n[,k]
  dif.k <- abs(tmp - median.n[k])
  #print(idx.vec[dif.k == min(dif.k)])
  median.idx[k] <- idx.vec[dif.k == min(dif.k)][1]
}

median.idx.df <- data.frame(Season = seasons,
                            median.idx = median.idx) %>%
  mutate(Year = lapply(str_split(Season, "/"), 
                       FUN = function(x) x[2]) %>% 
           unlist() %>% 
           as.numeric())

all.years %>% 
  left_join(median.idx.df, by = "Year") %>% 
  mutate(Season = paste0(Year-1, "/", Year)) %>%
  na.omit() -> median.idx.df

# Combine with data in Rugh et al. 
Rugh.data %>% 
  na.omit() %>%
  dplyr::select(Season, Year, median.idx) %>%
  rbind(median.idx.df %>% 
          dplyr::select(Season, Year, median.idx)) %>%
  mutate(Year.shifted = Year - min(Year)) -> median.idx.all.df

write.csv(median.idx.all.df,
          file = paste0("Data/median_migration_", end.year, ".csv"),
          quote = FALSE,
          row.names = FALSE)

# Use the segmented package to look at how the median dates changed
# over time:
lm.1 <- lm(median.idx ~ Year, data = median.idx.all.df)

lm.1.seg.1 <- segmented(lm.1, 
                        seg.Z = ~Year,
                        psi = list(Year = c(1980, 2006)))

slopes <- slope(lm.1.seg.1, conf.level = 0.95)

fitted <- predict(lm.1.seg.1, se.fit = T)
seg.1.fitted <- data.frame(fitted = fitted$fit,
                           SE = fitted$se.fit,
                           LCL = fitted$fit - 1.96 * fitted$se.fit,
                           UCL = fitted$fit + 1.96 * fitted$se.fit,
                           Year = median.idx.all.df %>% 
                             na.omit() %>% 
                             dplyr::select(Year),
                           Season = median.idx.all.df %>% 
                             na.omit() %>% 
                             dplyr::select(Season))

p.median.counts <- ggplot() +
  geom_point(data = median.idx.all.df, 
             aes(x = Year, y = median.idx)) + 
  geom_line(data = seg.1.fitted,
            aes(x = Year, y = fitted),
            size = 1.2, color = "darkblue") +
  geom_ribbon(data = seg.1.fitted,
              aes(x = Year, ymin = LCL, ymax = UCL),
              fill = "blue", alpha = 0.4)+
  geom_rect(data = UMEs, 
            aes(xmin = Year, xmax = Year+1,
                ymin = 30, ymax = 60),
            fill = "gold", alpha = 0.4) +
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  scale_x_continuous(breaks = c(1970, 1980, 1990, 2000, 2010, 2020)) +
  xlab("") + ylab("Median date (1 = December 1)")

if (save.fig)
  ggsave(filename = paste0("figures/Median_date_", YEAR, ".png"),
         plot = p.median.counts, device = "png",
         dpi = 600)

daily.n.df <- data.frame(daily.n)

daily.n.cumsum.df <- apply(daily.n, 
                           MARGIN = 2, cumsum) %>% 
  data.frame()

colnames(daily.n.df) <- seasons
colnames(daily.n.cumsum.df) <- seasons
#obsd.n.df$days <- idx.vec
daily.n.df.long <- pivot_longer(daily.n.df, 
                                everything(),
                                names_to = "Season", 
                                values_to = "Counts") %>%  
  arrange(Season)

daily.n.df.long$days <- rep(2:89, times = x)

daily.n.cumsum.df.long <- pivot_longer(daily.n.cumsum.df, 
                                       everything(),
                                       names_to = "Season", 
                                       values_to = "Counts") %>%  
  arrange(Season)

daily.n.cumsum.df.long$days <- rep(2:89, times = x)

p.daily.n <- ggplot(daily.n.df.long) +
  geom_path(aes(x = days, y = Counts)) +
  facet_wrap(vars(Season)) +
  geom_vline(data = median.idx.df %>% filter(Season %in% seasons),
             aes(xintercept = median.idx),
             color = "red", size = 1)

if (save.fig)
  ggsave(plot = p.daily.n,
         filename = paste0("figures/daily_counts_", YEAR, ".png"),
         device = "png", dpi = 600)

p.daily.n.cumu <- ggplot(daily.n.cumsum.df.long) +
  geom_path(aes(x = days, y = Counts)) +
  facet_wrap(vars(Season)) + 
  geom_vline(data = median.idx.df%>% filter(Season %in% seasons),
             aes(xintercept = median.idx),
             color = "red", size = 1) +
  geom_text(data = median.idx.df %>% filter(Season %in% seasons),
            aes(x = median.idx, 
                y = 2500, 
                label = median.idx)) + 
  ylab("Cumulative counts")

if (save.fig)
  ggsave(plot = p.daily.n.cumu,
         filename = paste0("figures/daily_counts_cumsum_", YEAR, ".png"),
         device = "png", dpi = 600)

# p.daily.N <- ggplot(daily.N.df.long) +
#   geom_path(aes(x = days, y = N)) +
#   facet_wrap(vars(Season)) + 
#   geom_vline(data = median.idx.df %>% filter(Season %in% seasons),
#              aes(xintercept = median.idx),
#              color = "red", size = 1)
# 
# if (save.fig)
#   ggsave(plot = p.daily.N,
#          filename = "figures/daily_N_2023.png",
#          device = "png", dpi = 600)

# p.median.date <- ggplot(median.idx.all.df) +
#   geom_point(aes(x = Year.shifted, y = median.idx))
```

As it was reported in a previous report (Eguchi et al. 2023), timing of migration, measured by the median migration date, changed significantly over the survey period (Figure \@ref(fig:Figure-phenology)). From the beginning of the survey (1967) through 1970s, they were generally earlier than 10 January (Day 40). They linearly increased over the 1980s, 1990s, and early 2000s. Since the mid 2000s, there was a linear decline. Estimated change points were `r signif(lm.1.seg.1$psi[1,2], 5)` (SE = `r signif(lm.1.seg.1$psi[1,3], 3)`) and `r signif(lm.1.seg.1$psi[2,2], 5)` (SE = `r signif(lm.1.seg.1$psi[2,3], 3)`). As expected, these estimated change points were statistically not different from those from the last year (1976 $\pm$ 3.63, 2008 $\pm$ 3.84). The estimated slopes for the three segments were `r signif(slopes$Year[1,1], 3)` (SE = `r signif(slopes$Year[1,2], 3)`), `r signif(slopes$Year[2,1], 3)` (SE = `r signif(slopes$Year[2,2], 3)`), and `r signif(slopes$Year[3,1], 3)` (SE = `r signif(slopes$Year[3,2], 3)`), respectively. Estimated slopes also were not different (-0.13 $\pm$ 0.361, 0.468 $\pm$ 0.077, -0.238 $\pm$ 0.221, Eguchi et al. 2023a). The median migration date for the 2023/2024 season was `r median.idx.df[nrow(median.idx.df), "median.idx"]`, which was `r median.idx.df[nrow(median.idx.df), "median.idx"] - median.idx.df[nrow(median.idx.df)-1, "median.idx"]` days later than the previous season. Biological and ecological significance of this difference is unknown. Studies on body conditions, environmental fluctuations, and health conditions of gray whales may provide information on possible mechanisms of changes in the migration timing of gray whales.

## Acknowledgements {.unnumbered}

We thank our visual observer team for their diligence and meticulous data recording, sometimes in the inclement weather. Annette Henry, Lynn Evans, Tina Chen, and Robin LeRoux provided logistical support and survey planning to successfully carry out the mission. Bob Brownell graciously provided us with space in his office and local hospitality. We thank Bryn Phillips and Robert Luckert at the Marine Pollution lab at Granite Canyon who continuously support our field effort at the study site. Their friendship and problem solving onsite are invaluable. X and Y improved this work by way of their careful reviews. Funding for this project was provided by NOAA/NMFS.

## Literature cited {.unnumbered}

::: {#refs}
:::

\newpage

## Tables and figures {.unnumbered}

```{r Table-Nhats-v1, echo=FALSE, warning=FALSE}
flextable(all.estimates.2024 %>% dplyr::select(-Year)) %>% 
  set_caption(paste0("Estimated abundance (Nhat) and 95% lower (LCL) and upper (UCL) confidence limits of gray whales from the visual surveys off Granite Canyon, CA. Estimates prior to the 2006/2007 season are from Laake et al. (2012), where confidence limits were computed using the lognormal distribution. For the 2006/2007 through 2023/2024 seasons, the method of Durban et al. (2016) was used. Nhat.2023 refers to the estimated abundance (Nhat) reported in Eguchi et al. 2023a."))  %>%
  colformat_double(j = c("LCL", "UCL"), digits = 1) %>%
  set_table_properties(width = 0.5, layout = "autofit")
```

\newpage

```{r Figure-daily-fit, echo=FALSE, message=FALSE, fig.cap="Daily estimated numbers of gray whales migrating through the sampling area off Granite Canyon. Black lines are medians and orange bands indicate 95% credible intervals from the method of Durban et al (2015). Solid circles indicate observed counts adjusted for the daily survey effort."}

knitr::include_graphics(paste0("figures/daily_estimates_", YEAR, ".png"))

```

\newpage

```{r Figure-nhats-v1, echo=FALSE, message=FALSE, fig.cap="Estimated abundance and 95% CIs (confidence intervals for the method of Laake et al. and credible intervals for the method of Durban et al.) of gray whales from the visual surveys off Granite Canyon, CA, between the 1967/1968 and 2023/2024 seasons. Estimates in green indicate those from Laake et al. (2012) whereas those in red (from the 2006/2007 season) indicate using the method in Durban et al. (2016). Yello boxes represent unusual mortality events."}

knitr::include_graphics(paste0("figures/nhats_", YEAR, ".png"))

```

\newpage

```{r Figure-phenology, echo=FALSE, message=FALSE, fig.cap="Changes in median date of gray whale migration at the sampling area off Granite Canyon, CA (the date when 50% of the whale sightings had been recorded). December 1 of each year is 0 and January 10 is 40. Data before the 2006/2007 sampling season are from Rugh et al. (2001, Table 1).  Regression lines are linear models with change points. Yellow vertical bars indicate the designated UME."}

knitr::include_graphics(paste0("figures/Median_date_", YEAR, ".png"))


```
